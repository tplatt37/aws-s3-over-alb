AWSTemplateFormatVersion: '2010-09-09'
Description: >
  Private API Gateway REST API accessible via an internet-facing ALB with
  custom domain, routing through API Gateway Interface VPC Endpoints.
  Includes ACM certificate, Route 53 DNS, host header rewrite, and a
  minimal Lambda custom resource to resolve VPC endpoint ENI private IPs
  for ALB target registration.

# ===========================================================================
# Parameters
# ===========================================================================
Parameters:
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: VPC ID to deploy resources into

  SubnetId1:
    Type: AWS::EC2::Subnet::Id
    Description: First subnet for VPC endpoint and ALB

  SubnetId2:
    Type: AWS::EC2::Subnet::Id
    Description: Second subnet for VPC endpoint and ALB

  HostedZoneId:
    Type: AWS::Route53::HostedZone::Id
    Description: Route 53 hosted zone ID for DNS record creation

  DomainName:
    Type: String
    Description: Custom domain name for the ALB (e.g., api.example.com)
    AllowedPattern: ^[a-zA-Z0-9][a-zA-Z0-9\-\.]*[a-zA-Z0-9]$

# ===========================================================================
# Resources
# ===========================================================================
Resources:

  # -------------------------------------------------------------------------
  # Security Groups
  # -------------------------------------------------------------------------
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow inbound HTTPS to ALB
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-alb-sg'

  VpcEndpointSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow HTTPS from ALB to VPC Endpoint ENIs
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          SourceSecurityGroupId: !Ref ALBSecurityGroup
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-vpce-sg'

  # -------------------------------------------------------------------------
  # API Gateway Interface VPC Endpoint (execute-api)
  # -------------------------------------------------------------------------
  ApiGatewayEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VpcId
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.execute-api'
      VpcEndpointType: Interface
      PrivateDnsEnabled: false
      SubnetIds:
        - !Ref SubnetId1
        - !Ref SubnetId2
      SecurityGroupIds:
        - !Ref VpcEndpointSecurityGroup

  # -------------------------------------------------------------------------
  # Lambda Custom Resource – Resolve ENI IDs to Private IPs
  # -------------------------------------------------------------------------
  ENIResolverRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: DescribeENIs
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ec2:DescribeNetworkInterfaces
                Resource: '*'

  ENIResolverFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-eni-ip-resolver'
      Runtime: python3.12
      Handler: index.handler
      Timeout: 30
      Role: !GetAtt ENIResolverRole.Arn
      Code:
        ZipFile: |
          import json
          import boto3
          import cfnresponse

          def handler(event, context):
              try:
                  if event['RequestType'] in ('Create', 'Update'):
                      eni_ids = event['ResourceProperties']['NetworkInterfaceIds']
                      ec2 = boto3.client('ec2')
                      resp = ec2.describe_network_interfaces(NetworkInterfaceIds=eni_ids)
                      ips = [eni['PrivateIpAddress'] for eni in resp['NetworkInterfaces']]
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, {
                          'IP1': ips[0],
                          'IP2': ips[1] if len(ips) > 1 else ips[0],
                          'IPs': ','.join(ips)
                      })
                  else:
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
              except Exception as e:
                  print(f"Error: {e}")
                  cfnresponse.send(event, context, cfnresponse.FAILED, {'Error': str(e)})

  ENIIPLookup:
    Type: Custom::ENIIPLookup
    Properties:
      ServiceToken: !GetAtt ENIResolverFunction.Arn
      NetworkInterfaceIds: !GetAtt ApiGatewayEndpoint.NetworkInterfaceIds

  # -------------------------------------------------------------------------
  # API Gateway – Private REST API
  # -------------------------------------------------------------------------
  ApiGateway:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: !Sub '${AWS::StackName}-private-api'
      Description: Private REST API accessible only via VPC Endpoint
      EndpointConfiguration:
        Types:
          - PRIVATE
        VpcEndpointIds:
          - !Ref ApiGatewayEndpoint
      Policy:
        Version: '2012-10-17'
        Statement:
          - Effect: Deny
            Principal: '*'
            Action: 'execute-api:Invoke'
            Resource: 'execute-api:/*'
            Condition:
              StringNotEquals:
                aws:sourceVpce: !Ref ApiGatewayEndpoint
          - Effect: Allow
            Principal: '*'
            Action: 'execute-api:Invoke'
            Resource: 'execute-api:/*'

  # /healthcheck resource
  HealthcheckResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref ApiGateway
      ParentId: !GetAtt ApiGateway.RootResourceId
      PathPart: healthcheck

  HealthcheckMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref ApiGateway
      ResourceId: !Ref HealthcheckResource
      HttpMethod: GET
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          - StatusCode: '200'
            ResponseTemplates:
              application/json: '{"status": "healthy"}'
      MethodResponses:
        - StatusCode: '200'
          ResponseModels:
            application/json: 'Empty'

  # /data resource
  DataResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref ApiGateway
      ParentId: !GetAtt ApiGateway.RootResourceId
      PathPart: data

  DataMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref ApiGateway
      ResourceId: !Ref DataResource
      HttpMethod: GET
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        RequestTemplates:
          application/json: '{"statusCode": 200}'
        IntegrationResponses:
          - StatusCode: '200'
            ResponseTemplates:
              application/json: '{"message": "Hello from Private API Gateway", "source": "mock-integration"}'
      MethodResponses:
        - StatusCode: '200'
          ResponseModels:
            application/json: 'Empty'

  # Deployment and Stage
  ApiDeployment:
    Type: AWS::ApiGateway::Deployment
    DependsOn:
      - HealthcheckMethod
      - DataMethod
    Properties:
      RestApiId: !Ref ApiGateway

  ApiStage:
    Type: AWS::ApiGateway::Stage
    Properties:
      RestApiId: !Ref ApiGateway
      DeploymentId: !Ref ApiDeployment
      StageName: prod

  # -------------------------------------------------------------------------
  # ACM Certificate (DNS Validation via Route 53)
  # -------------------------------------------------------------------------
  Certificate:
    Type: AWS::CertificateManager::Certificate
    Properties:
      DomainName: !Ref DomainName
      ValidationMethod: DNS
      DomainValidationOptions:
        - DomainName: !Ref DomainName
          HostedZoneId: !Ref HostedZoneId

  # -------------------------------------------------------------------------
  # Application Load Balancer (Internet-Facing)
  # -------------------------------------------------------------------------
  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub '${AWS::StackName}-alb'
      Scheme: internet-facing
      Type: application
      Subnets:
        - !Ref SubnetId1
        - !Ref SubnetId2
      SecurityGroups:
        - !Ref ALBSecurityGroup
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-alb'

  # -------------------------------------------------------------------------
  # Target Group – IP-based, HTTPS to VPC Endpoint ENIs
  # -------------------------------------------------------------------------
  ApiTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub '${AWS::StackName}-api-tg'
      VpcId: !Ref VpcId
      Protocol: HTTPS
      Port: 443
      TargetType: ip
      HealthCheckProtocol: HTTPS
      HealthCheckPort: '443'
      HealthCheckPath: /prod/healthcheck
      Matcher:
        HttpCode: '200'
      TargetGroupAttributes:
        - Key: stickiness.enabled
          Value: 'false'
      Targets:
        - Id: !GetAtt ENIIPLookup.IP1
          Port: 443
        - Id: !GetAtt ENIIPLookup.IP2
          Port: 443

  # -------------------------------------------------------------------------
  # HTTPS Listener
  # -------------------------------------------------------------------------
  ALBListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 443
      Protocol: HTTPS
      Certificates:
        - CertificateArn: !Ref Certificate
      SslPolicy: ELBSecurityPolicy-TLS13-1-2-2021-06
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref ApiTargetGroup

  # -------------------------------------------------------------------------
  # Listener Rule – Forward with Host Header Rewrite (Transform)
  # Rewrites Host header from custom domain to API Gateway execute-api URL
  # -------------------------------------------------------------------------
  ALBListenerRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref ALBListener
      Priority: 1
      Conditions:
        - Field: host-header
          HostHeaderConfig:
            Values:
              - !Ref DomainName
      Actions:
        - Type: forward
          TargetGroupArn: !Ref ApiTargetGroup
      Transforms:
        - Type: host-header-rewrite
          HostHeaderRewriteConfig:
            Rewrites:
              # Replace the Host header with the API Gateway execute-api URL
              # so API Gateway knows which API to invoke
              - Regex: "^(.*)$"
                Replace: !Sub "${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com"

  # -------------------------------------------------------------------------
  # Route 53 DNS Record – Alias to ALB
  # -------------------------------------------------------------------------
  DNSRecord:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref HostedZoneId
      Name: !Ref DomainName
      Type: A
      AliasTarget:
        DNSName: !GetAtt ApplicationLoadBalancer.DNSName
        HostedZoneId: !GetAtt ApplicationLoadBalancer.CanonicalHostedZoneID
        EvaluateTargetHealth: true

# ===========================================================================
# Outputs
# ===========================================================================
Outputs:
  ApiGatewayId:
    Description: API Gateway REST API ID
    Value: !Ref ApiGateway

  ApiGatewayUrl:
    Description: API Gateway invoke URL (via VPC Endpoint)
    Value: !Sub 'https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com/prod'

  ALBDNSName:
    Description: ALB DNS name
    Value: !GetAtt ApplicationLoadBalancer.DNSName

  CustomDomainURL:
    Description: Custom domain URL for accessing API Gateway via ALB
    Value: !Sub 'https://${DomainName}/prod'

  HealthcheckURL:
    Description: Healthcheck endpoint via custom domain
    Value: !Sub 'https://${DomainName}/prod/healthcheck'

  DataURL:
    Description: Data endpoint via custom domain
    Value: !Sub 'https://${DomainName}/prod/data'

  VPCEndpointId:
    Description: API Gateway Interface VPC Endpoint ID
    Value: !Ref ApiGatewayEndpoint

  TargetIP1:
    Description: First VPC Endpoint ENI private IP
    Value: !GetAtt ENIIPLookup.IP1

  TargetIP2:
    Description: Second VPC Endpoint ENI private IP
    Value: !GetAtt ENIIPLookup.IP2
